name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npm run format:check
      - run: npm run lint
      - run: npm run typecheck

  smoke:
    runs-on: ubuntu-latest
    needs: quality
    outputs:
      report_artifact: ${{ steps.meta.outputs.report_artifact }}
      pr_number: ${{ steps.meta.outputs.pr_number }}
      run_ts_utc: ${{ steps.meta.outputs.run_ts_utc }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Set run timestamp
        id: meta
        shell: bash
        run: |
          TS="$(date -u '+%Y%m%d-%H%M%S')"
          echo "RUN_TS=$(date -u '+%Y-%m-%d_%H-%M-%S_UTC')" >> $GITHUB_ENV
          echo "RUN_TS_COMPACT=${TS}" >> $GITHUB_ENV
          echo "report_artifact=playwright-report-${TS}" >> "$GITHUB_OUTPUT"
          echo "run_ts_utc=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_OUTPUT"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "pr_number=" >> "$GITHUB_OUTPUT"
          fi

      - run: npm ci
      - run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npm run test

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.report_artifact }}
          path: playwright-report/
          retention-days: 7
          if-no-files-found: warn

  publish-report:
    runs-on: ubuntu-latest
    needs: smoke
    if: always() && github.event_name == 'pull_request'
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download Playwright report artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.smoke.outputs.report_artifact }}
          path: report

      - name: Prepare Pages content (per PR)
        shell: bash
        run: |
          PR="${{ needs.smoke.outputs.pr_number }}"
          if [ -z "$PR" ]; then
            echo "No PR number found."
            exit 1
          fi

          rm -rf public
          mkdir -p "public/pr-${PR}"
          cp -R report/* "public/pr-${PR}/"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify-line-pr:
    runs-on: ubuntu-latest
    needs: [smoke, publish-report]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Send LINE notification (PR + Pages link)
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_TO: ${{ secrets.LINE_TO }}
          STATUS: ${{ needs.smoke.result }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          PR: ${{ needs.smoke.outputs.pr_number }}
          PAGE_URL: ${{ needs.publish-report.outputs.page_url }}
        run: |
          set -e
          RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"

          cat <<EOF > msg.txt
          CI: ${STATUS}
          Repo: ${REPO}
          PR: #${PR}
          Run: ${RUN_URL}
          Pages: ${PAGE_URL}pr-${PR}/
          Summary: ${PAGE_URL}pr-${PR}/summary.html
          EOF

          ESCAPED=$(python3 - <<'PY'
          import json
          with open("msg.txt", "r", encoding="utf-8") as f:
              print(json.dumps(f.read()))
          PY
          )

          curl -sS -X POST https://api.line.me/v2/bot/message/push \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"to\":\"${LINE_TO}\",\"messages\":[{\"type\":\"text\",\"text\":${ESCAPED}}]}"

  notify-line-push:
    runs-on: ubuntu-latest
    needs: smoke
    if: always() && github.event_name == 'push'
    steps:
      - name: Send LINE notification (push)
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_TO: ${{ secrets.LINE_TO }}
          STATUS: ${{ needs.smoke.result }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -e
          RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"

          cat <<EOF > msg.txt
          CI: ${STATUS}
          Repo: ${REPO}
          Run: ${RUN_URL}
          EOF

          ESCAPED=$(python3 - <<'PY'
          import json
          with open("msg.txt", "r", encoding="utf-8") as f:
              print(json.dumps(f.read()))
          PY
          )

          curl -sS -X POST https://api.line.me/v2/bot/message/push \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"to\":\"${LINE_TO}\",\"messages\":[{\"type\":\"text\",\"text\":${ESCAPED}}]}"
